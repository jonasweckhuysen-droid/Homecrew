<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Homecrew â€“ Agenda</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
.app-body {
  padding:10px;
  font-family: Arial, sans-serif;
  background:#f2f4f7;
}

.card {
  background:white;
  padding:15px;
  border-radius:14px;
  margin-bottom:15px;
  box-shadow:0 3px 6px rgba(0,0,0,0.05);
}

.week-header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}

.week-header button {
  background:#3a6ea5;
  color:white;
  border:none;
  border-radius:10px;
  padding:8px 12px;
}

.week-title {
  font-weight:bold;
}

.week-grid {
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap:8px;
}

.day-col {
  background:#fafafa;
  border-radius:12px;
  padding:8px;
  min-height:120px;
}

.day-header {
  font-weight:bold;
  font-size:13px;
  text-align:center;
  margin-bottom:6px;
  color:#3a6ea5;
}

.event {
  background:white;
  border-left:5px solid #3498db;
  border-radius:8px;
  padding:6px;
  margin-bottom:6px;
  font-size:12px;
  display:flex;
  flex-direction:column;
}

.event.google {
  border-left-color:#222;
  background:#f9f9f9;
}

.event-time {
  font-size:11px;
  color:#666;
}

.event-user {
  font-size:11px;
  font-weight:bold;
  display:flex;
  align-items:center;
  gap:4px;
}

input, textarea {
  width:100%;
  padding:8px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ddd;
}

.nav-btn {
  padding:8px 12px;
  border-radius:8px;
  background:#3a6ea5;
  color:white;
  border:none;
}
</style>
</head>

<body class="app-body">

<header class="topbar">
  <button onclick="location.href='dashboard.html'" class="home-btn">
    <i class="fas fa-home"></i>
  </button>
  <h2>ðŸ“… Homecrew Agenda</h2>
  <button onclick="logout()" class="home-btn">
    <i class="fas fa-sign-out-alt"></i>
  </button>
</header>

<main class="content">
  <h3 id="welcomeUser"></h3>

  <div class="card">
    <h4>Nieuwe afspraak</h4>
    <input id="eventTitle" placeholder="Titel">
    <input type="datetime-local" id="eventDate">
    <textarea id="eventDescription" placeholder="Beschrijving"></textarea>
    <button class="nav-btn" onclick="addLocalEvent()">Toevoegen</button>
  </div>

  <div class="card">
    <div class="week-header">
      <button onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
      <div class="week-title" id="weekTitle"></div>
      <button onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
    </div>

    <div class="week-grid" id="weekGrid"></div>
  </div>
</main>

<script>
/* ===== CONFIG ===== */
const LOCAL_EVENTS_KEY = "homecrewLocalEvents";
const GOOGLE_API_KEY = "AIzaSyCTgjVKj_ABJHEvDTdgPDu_ZVTBYV8PAT0";
const CALENDAR_ID = "b3756ae16d0f11ea12a33407c6077e5925740ab0ce0d19514aa77a7fc6a6e0c0@group.calendar.google.com";

/* ===== USER ===== */
const user = localStorage.getItem("homecrewUser") || sessionStorage.getItem("homecrewUser");
if (!user) location.href = "index.html";
document.getElementById("welcomeUser").innerText = "Welkom, " + user + " ðŸ‘‹";

function logout(){
  localStorage.clear();
  sessionStorage.clear();
  location.href = "index.html";
}

/* ===== WEEK LOGICA ===== */
let currentWeekStart = getWeekStart(new Date());

function getWeekStart(date){
  const d = new Date(date);
  const day = d.getDay() || 7;
  d.setDate(d.getDate() - day + 1);
  d.setHours(0,0,0,0);
  return d;
}

function changeWeek(offset){
  currentWeekStart.setDate(currentWeekStart.getDate() + offset * 7);
  loadWeek();
}

/* ===== GEZINSLEDEN ===== */
function getUserColor(u){
  if(!u) return "#999";
  u = u.toLowerCase();
  if(u==="jonas") return "#3498db";
  if(u==="liese") return "#e74c3c";
  if(u==="loreana") return "#ff69b4";
  return "#777";
}

function getUserIcon(u){
  if(!u) return "ðŸ‘¤";
  u = u.toLowerCase();
  if(u==="jonas") return "ðŸ‘¨";
  if(u==="liese") return "ðŸ‘©";
  if(u==="loreana") return "ðŸ‘§";
  return "ðŸ‘¤";
}

/* ===== EVENTS ===== */
function addLocalEvent(){
  const events = JSON.parse(localStorage.getItem(LOCAL_EVENTS_KEY) || "[]");
  events.push({
    user,
    title: eventTitle.value,
    date: eventDate.value,
    description: eventDescription.value
  });
  localStorage.setItem(LOCAL_EVENTS_KEY, JSON.stringify(events));
  eventTitle.value = "";
  eventDate.value = "";
  eventDescription.value = "";
  loadWeek();
}

/* ===== GOOGLE EVENTS (MET MEERDAAGS) ===== */
async function fetchGoogleEvents(){
  const res = await fetch(
    `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events` +
    `?key=${GOOGLE_API_KEY}&singleEvents=true&orderBy=startTime`
  );

  const data = await res.json();

  return (data.items || []).map(e => {
    const isAllDay = !!e.start.date;

    const start = isAllDay
      ? new Date(e.start.date)
      : new Date(e.start.dateTime);

    let end;
    if (isAllDay) {
      end = new Date(e.end.date);
      end.setDate(end.getDate() - 1); // Google end is exclusief
    } else {
      end = new Date(e.end.dateTime);
    }

    return {
      title: e.summary,
      start,
      end,
      isAllDay
    };
  });
}

/* ===== WEERGAVE ===== */
async function loadWeek(){
  const grid = document.getElementById("weekGrid");
  grid.innerHTML = "";

  const weekEnd = new Date(currentWeekStart);
  weekEnd.setDate(weekEnd.getDate() + 6);

  document.getElementById("weekTitle").innerText =
    currentWeekStart.toLocaleDateString("nl-BE") +
    " â€“ " +
    weekEnd.toLocaleDateString("nl-BE");

  const localEvents = JSON.parse(localStorage.getItem(LOCAL_EVENTS_KEY) || "[]");
  const googleEvents = await fetchGoogleEvents();

  for(let i=0;i<7;i++){
    const day = new Date(currentWeekStart);
    day.setDate(day.getDate()+i);

    const col = document.createElement("div");
    col.className = "day-col";

    col.innerHTML = `<div class="day-header">
      ${day.toLocaleDateString("nl-BE",{weekday:"short", day:"numeric"})}
    </div>`;

    // Lokale events
    localEvents
      .filter(e => new Date(e.date).toDateString() === day.toDateString())
      .forEach(e=>{
        col.innerHTML += `
          <div class="event" style="border-left-color:${getUserColor(e.user)}">
            <strong>${e.title}</strong>
            <div class="event-time">
              ${new Date(e.date).toLocaleTimeString("nl-BE",{hour:'2-digit',minute:'2-digit'})}
            </div>
            <div class="event-user">${getUserIcon(e.user)} ${e.user}</div>
            ${e.description ? `<div>${e.description}</div>` : ""}
          </div>`;
      });

    // Google events (ook meerdaags)
    googleEvents
      .filter(e => day >= e.start && day <= e.end)
      .forEach(e=>{
        col.innerHTML += `
          <div class="event google">
            <strong>${e.title}</strong>
            <div class="event-time">
              ${
                e.isAllDay
                  ? `ðŸ“† ${e.start.toLocaleDateString("nl-BE")} â€“ ${e.end.toLocaleDateString("nl-BE")}`
                  : `ðŸ•’ ${e.start.toLocaleTimeString("nl-BE",{hour:'2-digit',minute:'2-digit'})}`
              }
            </div>
            <div class="event-user">ðŸ“… Google</div>
          </div>`;
      });

    grid.appendChild(col);
  }
}

document.addEventListener("DOMContentLoaded", loadWeek);
</script>

</body>
</html>
