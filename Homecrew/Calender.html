import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { format, startOfMonth, endOfMonth, eachDayOfInterval, isSameMonth, isSameDay, addMonths, subMonths, parseISO, startOfWeek, endOfWeek } from 'date-fns';
import { nl } from 'date-fns/locale';
import { ChevronLeft, ChevronRight, Plus, X, Clock, Trash2 } from 'lucide-react';
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import PageHeader from '@/components/ui/PageHeader';

const colors = [
  { name: 'Indigo', value: '#6366f1' },
  { name: 'Pink', value: '#ec4899' },
  { name: 'Emerald', value: '#10b981' },
  { name: 'Amber', value: '#f59e0b' },
  { name: 'Blue', value: '#3b82f6' },
  { name: 'Purple', value: '#8b5cf6' },
];

export default function Calendar() {
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState(null);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [editingEvent, setEditingEvent] = useState(null);
  const [isImportOpen, setIsImportOpen] = useState(false);
  const [icsUrl, setIcsUrl] = useState('');
  const [importing, setImporting] = useState(false);
  const [formData, setFormData] = useState({
    title: '',
    description: '',
    date: '',
    start_time: '',
    end_time: '',
    member_color: '#6366f1',
    reminder: false,
    is_all_day: false
  });

  const queryClient = useQueryClient();

  const { data: events = [], isLoading } = useQuery({
    queryKey: ['calendarEvents'],
    queryFn: () => base44.entities.CalendarEvent.list('-date', 500),
  });

  const { data: members = [] } = useQuery({
    queryKey: ['familyMembers'],
    queryFn: () => base44.entities.FamilyMember.list(),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.CalendarEvent.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['calendarEvents'] });
      closeDialog();
    },
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.CalendarEvent.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['calendarEvents'] });
      closeDialog();
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.CalendarEvent.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['calendarEvents'] });
      closeDialog();
    },
  });

  const monthStart = startOfMonth(currentMonth);
  const monthEnd = endOfMonth(currentMonth);
  const calendarStart = startOfWeek(monthStart);
  const calendarEnd = endOfWeek(monthEnd);
  const days = eachDayOfInterval({ start: calendarStart, end: calendarEnd });

  const getEventsForDate = (date) => {
    const dateStr = format(date, 'yyyy-MM-dd');
    return events.filter(e => e.date === dateStr);
  };

  const openDialog = (date, event = null) => {
    if (event) {
      setEditingEvent(event);
      setFormData({
        title: event.title || '',
        description: event.description || '',
        date: event.date || '',
        start_time: event.start_time || '',
        end_time: event.end_time || '',
        member_color: event.member_color || '#6366f1',
        reminder: event.reminder || false,
        is_all_day: event.is_all_day || false
      });
    } else {
      setEditingEvent(null);
      setFormData({
        title: '',
        description: '',
        date: format(date, 'yyyy-MM-dd'),
        start_time: '',
        end_time: '',
        member_color: '#6366f1',
        reminder: false,
        is_all_day: false
      });
    }
    setIsDialogOpen(true);
  };

  const closeDialog = () => {
    setIsDialogOpen(false);
    setEditingEvent(null);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (editingEvent) {
      updateMutation.mutate({ id: editingEvent.id, data: formData });
    } else {
      createMutation.mutate(formData);
    }
  };

  const handleImportICS = async () => {
    if (!icsUrl.trim()) return;
    setImporting(true);
    
    try {
      const response = await fetch(icsUrl);
      const icsData = await response.text();
      
      // Parse ICS data (basic parser)
      const lines = icsData.split('\n');
      const events = [];
      let currentEvent = null;
      
      for (let line of lines) {
        line = line.trim();
        if (line.startsWith('BEGIN:VEVENT')) {
          currentEvent = {};
        } else if (line.startsWith('END:VEVENT') && currentEvent) {
          if (currentEvent.title && currentEvent.date) {
            events.push(currentEvent);
          }
          currentEvent = null;
        } else if (currentEvent) {
          if (line.startsWith('SUMMARY:')) {
            currentEvent.title = line.substring(8);
          } else if (line.startsWith('DTSTART')) {
            const dateMatch = line.match(/(\d{4})(\d{2})(\d{2})/);
            if (dateMatch) {
              currentEvent.date = `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}`;
            }
            const timeMatch = line.match(/T(\d{2})(\d{2})/);
            if (timeMatch) {
              currentEvent.start_time = `${timeMatch[1]}:${timeMatch[2]}`;
            } else {
              currentEvent.is_all_day = true;
            }
          } else if (line.startsWith('DTEND')) {
            const timeMatch = line.match(/T(\d{2})(\d{2})/);
            if (timeMatch) {
              currentEvent.end_time = `${timeMatch[1]}:${timeMatch[2]}`;
            }
          } else if (line.startsWith('DESCRIPTION:')) {
            currentEvent.description = line.substring(12);
          }
        }
      }
      
      // Import events
      for (const event of events) {
        await createMutation.mutateAsync({
          ...event,
          member_color: '#6366f1',
          reminder: false,
          is_all_day: event.is_all_day || false
        });
      }
      
      alert(`‚úÖ ${events.length} afspraken ge√Ømporteerd!`);
      setIsImportOpen(false);
      setIcsUrl('');
    } catch (error) {
      alert('‚ùå Kon agenda niet importeren. Controleer de URL.');
    }
    setImporting(false);
  };

  return (
    <div className="max-w-6xl mx-auto">
      <PageHeader 
        title="Familie Agenda"
        subtitle="Houd iedereen op de hoogte"
        action={
          <div className="flex gap-2">
            <Button 
              variant="outline"
              onClick={() => setIsImportOpen(true)}
              className="hidden sm:flex text-blue-600 border-blue-200 hover:bg-blue-50"
            >
              üìÖ Importeer Agenda
            </Button>
            <Button 
              onClick={() => openDialog(new Date())}
              className="bg-gradient-to-r from-indigo-500 to-violet-600 hover:from-indigo-600 hover:to-violet-700 shadow-lg shadow-indigo-200"
            >
              <Plus className="w-4 h-4 mr-2" /> Afspraak Toevoegen
            </Button>
          </div>
        }
      />

      <Card className="border-0 shadow-sm overflow-hidden">
        <CardContent className="p-0">
          {/* Calendar Header */}
          <div className="flex items-center justify-between p-4 md:p-6 border-b border-slate-100 bg-white">
            <Button 
              variant="ghost" 
              size="icon"
              onClick={() => setCurrentMonth(subMonths(currentMonth, 1))}
            >
              <ChevronLeft className="w-5 h-5" />
            </Button>
            <h2 className="text-xl font-bold text-slate-800">
              {format(currentMonth, 'MMMM yyyy', { locale: nl })}
            </h2>
            <Button 
              variant="ghost" 
              size="icon"
              onClick={() => setCurrentMonth(addMonths(currentMonth, 1))}
            >
              <ChevronRight className="w-5 h-5" />
            </Button>
          </div>

          {/* Days of Week */}
          <div className="grid grid-cols-7 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-indigo-50/30">
            {['Zo', 'Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za'].map((day) => (
              <div key={day} className="p-2 md:p-3 text-center text-xs md:text-sm font-semibold text-slate-600">
                {day}
              </div>
            ))}
          </div>

          {/* Calendar Grid */}
          <div className="grid grid-cols-7 bg-white">
            {days.map((day, idx) => {
              const dayEvents = getEventsForDate(day);
              const isToday = isSameDay(day, new Date());
              const isCurrentMonth = isSameMonth(day, currentMonth);

              return (
                <div
                  key={idx}
                  className={`min-h-[80px] md:min-h-[120px] p-1 md:p-2 border-b border-r border-slate-100 cursor-pointer transition-colors hover:bg-slate-50 ${
                    !isCurrentMonth ? 'bg-slate-50/50' : ''
                  }`}
                  onClick={() => openDialog(day)}
                >
                  <div className={`text-sm font-medium mb-1 w-7 h-7 flex items-center justify-center rounded-full ${
                    isToday 
                      ? 'bg-indigo-600 text-white' 
                      : isCurrentMonth 
                        ? 'text-slate-700' 
                        : 'text-slate-400'
                  }`}>
                    {format(day, 'd')}
                  </div>
                  <div className="space-y-1">
                    {dayEvents.slice(0, 3).map((event) => (
                                <div
                                  key={event.id}
                                  className="text-xs truncate px-1.5 py-0.5 rounded-md text-white cursor-pointer hover:opacity-80 font-medium shadow-sm"
                                  style={{ backgroundColor: event.member_color || '#6366f1' }}
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    openDialog(day, event);
                                  }}
                                >
                                  {!event.is_all_day && event.start_time && (
                                    <span className="opacity-90 mr-1">{event.start_time.slice(0, 5)}</span>
                                  )}
                                  {event.title}
                                </div>
                              ))}
                    {dayEvents.length > 3 && (
                      <div className="text-xs text-slate-500 px-1">
                        +{dayEvents.length - 3} meer
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </CardContent>
      </Card>

      {/* Event Dialog */}
      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center justify-between">
              {editingEvent ? 'Afspraak Bewerken' : 'Nieuwe Afspraak'}
              {editingEvent && (
                <Button 
                  variant="ghost" 
                  size="icon"
                  className="text-red-500 hover:text-red-600 hover:bg-red-50"
                  onClick={() => deleteMutation.mutate(editingEvent.id)}
                >
                  <Trash2 className="w-4 h-4" />
                </Button>
              )}
            </DialogTitle>
          </DialogHeader>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <Label htmlFor="title">Titel</Label>
              <Input
                id="title"
                value={formData.title}
                onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                placeholder="bijv. Voetbaltraining"
                required
              />
            </div>

            <div>
              <Label htmlFor="date">Datum</Label>
              <Input
                id="date"
                type="date"
                value={formData.date}
                onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                required
              />
            </div>

            <div className="flex items-center gap-3">
              <Switch
                id="all_day"
                checked={formData.is_all_day}
                onCheckedChange={(checked) => setFormData({ ...formData, is_all_day: checked })}
              />
              <Label htmlFor="all_day">Hele dag</Label>
            </div>

            {!formData.is_all_day && (
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <Label htmlFor="start_time">Starttijd</Label>
                  <Input
                    id="start_time"
                    type="time"
                    value={formData.start_time}
                    onChange={(e) => setFormData({ ...formData, start_time: e.target.value })}
                  />
                </div>
                <div>
                  <Label htmlFor="end_time">Eindtijd</Label>
                  <Input
                    id="end_time"
                    type="time"
                    value={formData.end_time}
                    onChange={(e) => setFormData({ ...formData, end_time: e.target.value })}
                  />
                </div>
              </div>
            )}

            <div>
              <Label>Kleur</Label>
              <div className="flex gap-2 mt-2">
                {colors.map((color) => (
                  <button
                    key={color.value}
                    type="button"
                    className={`w-8 h-8 rounded-full transition-transform ${
                      formData.member_color === color.value ? 'scale-110 ring-2 ring-offset-2 ring-slate-300' : ''
                    }`}
                    style={{ backgroundColor: color.value }}
                    onClick={() => setFormData({ ...formData, member_color: color.value })}
                  />
                ))}
              </div>
            </div>

            <div>
              <Label htmlFor="description">Notities</Label>
              <Textarea
                id="description"
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                placeholder="Voeg notities toe..."
                rows={2}
              />
            </div>

            <div className="flex gap-3 pt-2">
              <Button type="button" variant="outline" onClick={closeDialog} className="flex-1">
                Annuleren
              </Button>
              <Button 
                type="submit" 
                className="flex-1 bg-gradient-to-r from-indigo-500 to-violet-600"
                disabled={createMutation.isPending || updateMutation.isPending}
              >
                {editingEvent ? 'Bijwerken' : 'Aanmaken'}
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* Import ICS Dialog */}
      <Dialog open={isImportOpen} onOpenChange={setIsImportOpen}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle>üìÖ Google Agenda Importeren</DialogTitle>
          </DialogHeader>
          <div className="space-y-4">
            <div className="p-3 bg-blue-50 rounded-lg text-sm text-blue-900">
              <p className="font-medium mb-2">Hoe krijg ik mijn agenda URL?</p>
              <ol className="space-y-1 text-xs list-decimal ml-4">
                <li>Open Google Agenda op je computer</li>
                <li>Klik op de 3 puntjes naast je agenda</li>
                <li>Kies "Instellingen en delen"</li>
                <li>Scroll naar "Agenda integreren"</li>
                <li>Kopieer de "Geheime adres in iCal-indeling" URL</li>
              </ol>
            </div>
            <div>
              <Label htmlFor="ics-url">ICS Feed URL</Label>
              <Input
                id="ics-url"
                value={icsUrl}
                onChange={(e) => setIcsUrl(e.target.value)}
                placeholder="https://calendar.google.com/calendar/ical/..."
                className="font-mono text-xs"
              />
            </div>
            <div className="flex gap-3">
              <Button 
                type="button" 
                variant="outline" 
                onClick={() => setIsImportOpen(false)}
                className="flex-1"
              >
                Annuleren
              </Button>
              <Button 
                onClick={handleImportICS}
                className="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600"
                disabled={importing || !icsUrl.trim()}
              >
                {importing ? 'Importeren...' : 'Importeer'}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
