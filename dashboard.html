<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Homecrew - Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="style.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
body { margin:0; background:#f2f6ff; font-family:Arial,sans-serif; }
.dashboard-container { padding:15px; max-width:480px; margin:auto; }

/* Welkomstblok */
.welcome-banner { text-align:center; background:linear-gradient(135deg,#667eea,#764ba2); color:white; padding:20px 15px; border-radius:20px; margin-bottom:20px; }
.welcome-banner h1 { margin:0 0 8px 0; }

/* Weerblok */
.weather-block { display:flex; justify-content:center; align-items:center; gap:12px; margin-top:10px; font-size:18px; }
.weather-block i { font-size:28px; color:#FFD700; }

/* Knoppen grid */
.dashboard-buttons { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
.dash-btn { position:relative; padding:20px 10px; border-radius:18px; color:white; text-align:center; font-weight:bold; cursor:pointer; box-shadow:0 10px 15px rgba(0,0,0,0.1); transition:0.2s ease; }
.dash-btn i { font-size:28px; display:block; margin-bottom:8px; }
.dash-btn:active { transform:scale(0.95); }
.agenda { background: linear-gradient(135deg,#ff9966,#ff5e62); }
.boodschappenlijst { background: linear-gradient(135deg,#56ccf2,#2f80ed); }
.berichten { background: linear-gradient(135deg,#a8ff78,#78ffd6); }
.taken { background: linear-gradient(135deg,#f7971e,#ffd200); }
.locatie { background: linear-gradient(135deg,#c471f5,#fa71cd); }

/* Badge voor ongelezen berichten */
.badge {
  position: absolute;
  top: 6px;
  right: 6px;
  background:red;
  color:white;
  border-radius:50%;
  padding:2px 6px;
  font-size:10px;
  font-weight:bold;
  display:none;
}

/* Logout */
.logout-btn { margin-top:25px; width:100%; padding:15px; border:none; border-radius:30px; background:#ff4d4d; color:white; font-size:16px; font-weight:bold; }
.logout-btn i { margin-right:6px; }
</style>
</head>
<body>

<div class="dashboard-container">

    <div class="welcome-banner">
        <h1 id="welcome"></h1>
        <p>Wat gaan we vandaag doen? ðŸŒˆ</p>

        <!-- Live weer -->
        <div class="weather-block">
            <i id="weatherIcon" class="fas fa-sun"></i>
            <span id="weatherTemp">--Â°C</span>
            <span id="weatherTime">--:--</span>
        </div>
    </div>

    <div class="dashboard-buttons">
        <div class="dash-btn agenda" id="btnAgenda"><i class="fas fa-calendar-alt"></i>Agenda</div>
        <div class="dash-btn boodschappenlijst" id="btnBoodschappen"><i class="fas fa-shopping-basket"></i>Boodschappen</div>
        <div class="dash-btn berichten" id="btnBerichten">
            <i class="fas fa-comments"></i>Berichten
            <span class="badge" id="badgeBerichten">0</span>
        </div>
        <div class="dash-btn taken" id="btnTaken"><i class="fas fa-list-check"></i>Taken</div>
        <div class="dash-btn locatie" id="btnLocatie"><i class="fas fa-location-dot"></i>Locatie</div>
    </div>

    <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Uitloggen</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

// ================== Firebase ==================
const firebaseConfig = {
    apiKey: "AIzaSyCwlr069pxNXEEhIEGNug5Ly_kKSuvxSzs",
    authDomain: "homecrew-d8e21.firebaseapp.com",
    projectId: "homecrew-d8e21",
    storageBucket: "homecrew-d8e21.firebasestorage.app",
    messagingSenderId: "47664248188",
    appId: "1:47664248188:web:0994c6b2ba07f6fee060f9",
    measurementId: "G-5R58JL5D5K"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ================== Gebruiker ==================
const user = localStorage.getItem("homecrewUser") || sessionStorage.getItem("homecrewUser");
if(!user){ window.location.href="index.html"; }
document.getElementById("welcome").innerText = `Welkom, ${user} ðŸ‘‹`;

// ================== Navigatie ==================
document.getElementById("btnAgenda").onclick = () => window.location.href="agenda.html";
document.getElementById("btnBoodschappen").onclick = () => window.location.href="boodschappen.html";
document.getElementById("btnTaken").onclick = () => window.location.href="taken.html";
document.getElementById("btnLocatie").onclick = () => window.location.href="locatie.html";
document.getElementById("logoutBtn").onclick = () => {
    localStorage.removeItem("homecrewUser");
    sessionStorage.removeItem("homecrewUser");
    window.location.href="index.html";
};

// ================== Weer ==================
const weatherIcon = document.getElementById("weatherIcon");
const weatherTemp = document.getElementById("weatherTemp");
const weatherTime = document.getElementById("weatherTime");
const API_KEY = "4a993261a71ece889094805bab5b864a"; 
const LAT = 51.2012;
const LON = 4.8170;

async function updateWeather() {
    try {
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LON}&appid=${API_KEY}&units=metric&lang=nl`);
        if(!res.ok) throw new Error("OpenWeatherMap API response niet OK");
        const data = await res.json();
        const temp = Math.round(data.main.temp);
        const weatherId = data.weather[0].id;
        let iconClass = "fa-sun";
        if(weatherId >= 200 && weatherId < 300) iconClass="fa-bolt";
        else if(weatherId >= 300 && weatherId < 600) iconClass="fa-cloud-showers-heavy";
        else if(weatherId >= 600 && weatherId < 700) iconClass="fa-snowflake";
        else if(weatherId >= 700 && weatherId < 800) iconClass="fa-smog";
        else if(weatherId === 800) iconClass="fa-sun";
        else if(weatherId > 800) iconClass="fa-cloud";
        weatherIcon.className = `fas ${iconClass}`;
        weatherTemp.innerText = temp + "Â°C";
        const now = new Date();
        weatherTime.innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    } catch(e) {
        console.error("Weer kon niet geladen worden:", e);
        weatherTemp.innerText="--Â°C";
        weatherTime.innerText="--:--";
        weatherIcon.className="fas fa-sun";
    }
}
updateWeather();
setInterval(updateWeather, 60000);

// ================== Ongelezen berichten badge ==================
const badgeEl = document.getElementById("badgeBerichten");
const messagesRef = collection(db, "messages");

function updateUnreadMessages(count){
    if(count > 0){
        badgeEl.style.display = "inline-block";
        badgeEl.textContent = count;
    } else {
        badgeEl.style.display = "none";
    }
}

// Live listener voor ongelezen berichten
onSnapshot(messagesRef, (snapshot) => {
    let unreadCount = 0;
    snapshot.forEach(docSnap => {
        if(!docSnap.data().read) unreadCount++;
    });
    updateUnreadMessages(unreadCount);
});

// Open berichtenpagina en markeer ongelezen berichten als gelezen
document.getElementById("btnBerichten").onclick = () => {
    window.location.href = "berichten.html";

    (async () => {
        const snapshot = await getDocs(messagesRef);
        snapshot.forEach(docSnap => {
            if(!docSnap.data().read) {
                updateDoc(doc(db, "messages", docSnap.id), { read: true });
            }
        });
    })();

    updateUnreadMessages(0);
};
</script>

</body>
</html>
