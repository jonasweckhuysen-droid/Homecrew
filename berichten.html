<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Homecrew - Berichten</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* ===== PAGINA SPECIFIEK ===== */

.content{
  padding:15px;
}

.card{
  background:white;
  padding:15px;
  border-radius:20px;
}

.chat-box{
  max-height:300px;
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
}

.msg-bubble{
  position: relative;
  padding:10px 14px;
  border-radius:12px;
  margin-bottom:10px;
  color:white;
  max-width:75%;
  word-wrap:break-word;
}

.msg-meta{
  font-size:0.75em;
  margin-top:3px;
  opacity:0.8;
}

.msg-right{
  align-self:flex-end;
}

/* DELETE KNOP */
.delete-btn{
  position:absolute;
  top:6px;
  right:8px;
  background:none;
  border:none;
  color:white;
  cursor:pointer;
  font-size:14px;
  opacity:0.8;
}

.delete-btn:hover{
  opacity:1;
}

#messageInput{
  width:100%;
  padding:8px;
  margin:6px 0;
  border-radius:6px;
  border:1px solid #ddd;
  box-sizing:border-box;
}

.main-btn{
  padding:10px 15px;
  background:#667eea;
  border:none;
  color:white;
  border-radius:10px;
  cursor:pointer;
}
</style>
</head>

<body class="app-body">

<!-- HEADER -->
<header class="topbar">
  <button onclick="window.location.href='dashboard.html'" class="home-btn">
    <i class="fas fa-home"></i>
  </button>

  <h2>üí¨ Berichten</h2>

  <button onclick="logout()" class="home-btn">
    <i class="fas fa-sign-out-alt"></i>
  </button>
</header>

<main class="content">
  <h3 id="welcomeUser"></h3>

  <div class="card">
    <div id="chatBox" class="chat-box"></div>

    <input type="text" id="messageInput" placeholder="Typ je bericht..." />
    <button class="main-btn" onclick="sendMessage()">Verstuur</button>
  </div>
</main>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  serverTimestamp,
  deleteDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCwlr069pxNXEEhIEGNug5Ly_kKSuvxSzs",
  authDomain: "homecrew-d8e21.firebaseapp.com",
  projectId: "homecrew-d8e21",
  storageBucket: "homecrew-d8e21.appspot.com",
  messagingSenderId: "47664248188",
  appId: "1:47664248188:web:0994c6b2ba07f6fee060f9",
  measurementId: "G-5R58JL5D5K"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= GEBRUIKER ================= */
const user = localStorage.getItem("homecrewUser") || sessionStorage.getItem("homecrewUser");
if (!user) window.location.href = "index.html";

document.getElementById("welcomeUser").innerText = "Welkom, " + user + " üëã";

/* ================= LOGOUT ================= */
window.logout = function(){
  localStorage.clear();
  sessionStorage.clear();
  location.href = "index.html";
};

/* ================= KLEUREN PER GEBRUIKER ================= */
function getUserColor(u){
  u = u.toLowerCase();
  if (u === "jonas") return "#3498db";
  if (u === "liese") return "#e74c3c";
  if (u === "loreana") return "#ff69b4";
  return "#555";
}

/* ================= FIRESTORE COLLECTION ================= */
const messagesCol = collection(db, "homecrewMessages");

/* ================= REALTIME UPDATES ================= */
onSnapshot(messagesCol, (snapshot) => {
    const chatBox = document.getElementById("chatBox");
    chatBox.innerHTML = "";

    const sorted = snapshot.docs.sort((a,b) =>
        (a.data().timestamp?.seconds || 0) - (b.data().timestamp?.seconds || 0)
    );

    sorted.forEach(docSnap => {
        const msg = docSnap.data();

        const bubble = document.createElement("div");
        bubble.className = "msg-bubble";
        bubble.style.background = getUserColor(msg.user);

        if (msg.user === user){
            bubble.classList.add("msg-right");
        }

        bubble.innerHTML = `
            <strong>${msg.user}</strong><br>
            ${msg.text}
            <div class="msg-meta">
              ${msg.timestamp?.seconds ? new Date(msg.timestamp.seconds*1000).toLocaleString("nl-BE") : ""}
            </div>
        `;

        /* üóëÔ∏è Alleen eigen berichten kunnen verwijderd worden */
        if (msg.user === user) {
          const delBtn = document.createElement("button");
          delBtn.className = "delete-btn";
          delBtn.innerHTML = `<i class="fas fa-trash"></i>`;
          delBtn.onclick = () => deleteMessage(docSnap.id);
          bubble.appendChild(delBtn);
        }

        chatBox.appendChild(bubble);
    });

    chatBox.scrollTop = chatBox.scrollHeight;
});

/* ================= VERWIJDER BERICHT ================= */
async function deleteMessage(id){
  if (!confirm("Dit bericht verwijderen?")) return;
  await deleteDoc(doc(db, "homecrewMessages", id));
}

/* ================= VERSTUREN ================= */
window.sendMessage = async function(){
    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if(!text) return;

    try {
        await addDoc(messagesCol, {
            user,
            text,
            timestamp: serverTimestamp()
        });
        input.value = "";
    } catch (error) {
        console.error("Fout bij verzenden:", error);
        alert("Kan bericht niet verzenden.");
    }
};
</script>

</body>
</html>
