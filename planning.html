<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Homecrew ‚Äì Weekplanning</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="style.css">

<style>
/* ================== Modal ================== */
.modal {
  display:none;
  position:fixed;
  top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  justify-content:center; align-items:center;
  z-index:999;
}
.modal-content {
  background:white; padding:20px; border-radius:12px; width:90%; max-width:400px;
}
.modal-content input, .modal-content select { width:100%; padding:6px; margin:5px 0 10px 0; }
.modal-content button { padding:8px 12px; background:#667eea; color:white; border:none; border-radius:8px; cursor:pointer; }
.close { float:right; cursor:pointer; font-size:22px; }

/* ================== Table ================== */
.table-wrapper { overflow-x:auto; }
#planningTable { width:100%; border-collapse: collapse; }
#planningTable th, #planningTable td { border:1px solid #ddd; padding:8px; text-align:center; position:relative; }
#planningTable td.activity { color:white; font-weight:bold; cursor:pointer; }
#planningTable td.activity span { display:block; position:absolute; top:0; left:0; width:100%; height:100%; padding:4px; box-sizing:border-box; border-radius:4px; }
</style>
</head>

<body>

<div class="topbar">
  <button class="home-btn" onclick="window.location.href='dashboard.html'">
    <i class="fas fa-home"></i>
  </button>
  <h2>üìÖ Weekplanning</h2>
  <div style="width:40px;"></div>
</div>

<div class="content">
<div class="card">

<!-- WEEK SWITCH -->
<div class="week-nav">
  <button id="prevWeek">‚Üê</button>
  <span id="currentWeek"></span>
  <button id="nextWeek">‚Üí</button>
</div>

<!-- FILTERS -->
<div class="filter-buttons">
  <button class="filter-btn all active" data-user="all">Iedereen</button>
  <button class="filter-btn jonas" data-user="Jonas">Jonas</button>
  <button class="filter-btn liese" data-user="Liese">Liese</button>
  <button class="filter-btn loreana" data-user="Loreana">Loreana</button>
</div>

<div class="table-wrapper">
<table id="planningTable"></table>
</div>

</div>
</div>

<!-- ===== Modal ===== -->
<div id="activityModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Activiteit plannen / bewerken</h3>
    <label>Beschrijving:</label>
    <input type="text" id="activityText" placeholder="Wat gaan we doen?" />
    
    <label>Startuur:</label>
    <input type="time" id="activityStart" value="08:00" />

    <label>Duur (uren):</label>
    <input type="number" id="activityDuration" min="1" max="24" value="1" />

    <button id="saveActivity">Opslaan</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

// ================= FIREBASE =================
const firebaseConfig = {
    apiKey: "AIzaSyCwlr069pxNXEEhIEGNug5Ly_kKSuvxSzs",
    authDomain: "homecrew-d8e21.firebaseapp.com",
    projectId: "homecrew-d8e21",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ================= GEBRUIKER =================
const user = localStorage.getItem("homecrewUser") || sessionStorage.getItem("homecrewUser") || "Onbekend";
const userColors = { "Jonas": "#2196f3", "Liese": "#f44336", "Loreana": "#e91e63" };
const myColor = userColors[user] || "#9e9e9e";

// ================= WEEK =================
let currentDate = new Date();
let activeUser = "all";

const currentWeek = document.getElementById("currentWeek");
const days = ["Ma","Di","Wo","Do","Vr","Za","Zo"];
const table = document.getElementById("planningTable");

// ================= MODAL =================
const modal = document.getElementById("activityModal");
const closeModal = document.querySelector(".close");
let editingActivity = null; // Houdt bij welke activiteit wordt bewerkt

closeModal.onclick = ()=> modal.style.display = "none";
window.onclick = (e)=> { if(e.target === modal) modal.style.display="none"; };

// ================= FUNCTIES =================
function getWeekRange(date){
  const start = new Date(date); start.setDate(start.getDate() - start.getDay() + 1);
  const end = new Date(start); end.setDate(start.getDate() + 6);
  return { start, end };
}

function updateWeekText(){
  const week = getWeekRange(currentDate);
  currentWeek.innerText = week.start.toLocaleDateString("nl-BE")+" - "+week.end.toLocaleDateString("nl-BE");
}

function buildTable(){
  let html = "<tr><th>Uur</th>"; days.forEach(d=>html+=`<th>${d}</th>`); html+="</tr>";
  for(let hour=0; hour<24; hour++){
    html+=`<tr><td class="hour">${hour}:00</td>`;
    days.forEach(day=>html+=`<td data-day="${day}" data-hour="${hour}"></td>`);
    html+="</tr>";
  }
  table.innerHTML = html;
  addCellListeners();
}

// Open modal voor nieuwe of bestaande activiteit
function openModal(day, startHour=8, text="", duration=1){
  editingActivity = {day, startHour};
  document.getElementById("activityText").value = text;
  document.getElementById("activityStart").value = `${String(startHour).padStart(2,'0')}:00`;
  document.getElementById("activityDuration").value = duration;
  modal.style.display = "flex";
}

// ================= CELL LISTENERS =================
function addCellListeners(){
  document.querySelectorAll("td[data-day]").forEach(cell=>{
    cell.onclick = ()=>{
      const hour = parseInt(cell.dataset.hour);
      const day = cell.dataset.day;
      if(cell.classList.contains("activity")){
        const text = cell.querySelector("span")?.innerText.split(" (")[0] || "";
        let duration = 1;
        // Tel het aantal aaneengesloten activiteiten
        let nextHour = hour+1;
        while(document.querySelector(`td[data-day="${day}"][data-hour="${nextHour}"]`)?.classList.contains("activity")){ duration++; nextHour++; }
        openModal(day, hour, text, duration);
      } else {
        openModal(day, hour);
      }
    };
  });
}

// ================= SAVE ACTIVITY =================
document.getElementById("saveActivity").onclick = async ()=>{
  const text = document.getElementById("activityText").value.trim();
  const start = document.getElementById("activityStart").value;
  const duration = parseInt(document.getElementById("activityDuration").value);
  if(!text || !start || !duration) return;

  const week = getWeekRange(currentDate).start.toISOString().split("T")[0];
  const [startHour, startMin] = start.split(":").map(Number);

  // Verwijder oude activiteit (indien bewerken)
  if(editingActivity){
    for(let i=0;i<24;i++){
      const id = `${week}-${editingActivity.day}-${editingActivity.startHour + i}`;
      await deleteDoc(doc(db,"planning",id)).catch(()=>{});
    }
  }

  // Sla nieuwe activiteit op
  for(let i=0;i<duration;i++){
    const hour = startHour + i;
    if(hour>23) break;
    const id = `${week}-${editingActivity?.day || editingActivity?.day || 'Ma'}-${hour}`;
    await setDoc(doc(db,"planning",id),{
      text: text+(i>0 ? "" : ""),
      user,
      color: myColor,
      day: editingActivity?.day || editingActivity?.day || 'Ma',
      hour,
      week,
      updated: new Date().toISOString()
    });
  }

  modal.style.display="none";
  editingActivity=null;
  loadWeekData();
}

// ================= FILTER =================
document.querySelectorAll(".filter-btn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    activeUser = btn.dataset.user;
    loadWeekData();
  };
});

// ================= WEEK SWITCH =================
document.getElementById("prevWeek").onclick = ()=>{
  currentDate.setDate(currentDate.getDate()-7); updateWeekText(); buildTable(); loadWeekData();
};
document.getElementById("nextWeek").onclick = ()=>{
  currentDate.setDate(currentDate.getDate()+7); updateWeekText(); buildTable(); loadWeekData();
};

// ================= LOAD DATA =================
function loadWeekData(){
  const week = getWeekRange(currentDate).start.toISOString().split("T")[0];
  onSnapshot(collection(db,"planning"), snapshot=>{
    document.querySelectorAll("td[data-day]").forEach(c=>{
      c.innerHTML=""; c.style.background="white"; c.style.color="black"; c.classList.remove("activity");
    });
    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      if(data.week!==week) return;
      if(activeUser!=="all" && data.user!==activeUser) return;
      const cell = document.querySelector(`td[data-day="${data.day}"][data-hour="${data.hour}"]`);
      if(cell){
        cell.classList.add("activity");
        cell.innerHTML=`<span style="background:${data.color}">${data.text} (${data.user})</span>`;
      }
    });
  });
}

// ================= START =================
updateWeekText(); buildTable(); loadWeekData();

</script>

</body>
</html>
