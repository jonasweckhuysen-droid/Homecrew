import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { 
  getFirestore, doc, setDoc, onSnapshot, collection, onSnapshot as onSnap 
} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCwlr069pxNXEEhIEGNug5Ly_kKSuvxSzs",
    authDomain: "homecrew-d8e21.firebaseapp.com",
    projectId: "homecrew-d8e21",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ================== Gegevens ==================
const user = localStorage.getItem("homecrewUser") || sessionStorage.getItem("homecrewUser") || "Onbekend";

const userColors = {
  "Jonas": "#2196f3",    // Blauw
  "Liese": "#f44336",    // Rood
  "Loreana": "#e91e63",  // Roze
};

const myColor = userColors[user] || "#9e9e9e"; // fallback grijs

const days = ["Ma", "Di", "Wo", "Do", "Vr", "Za", "Zo"];
const table = document.getElementById("planningTable");

// ================== Tabel maken ==================
let html = "<tr><th>Uur</th>";
days.forEach(d => html+=`<th>${d}</th>`);
html += "</tr>";

for(let hour=0; hour<24; hour++){
  html+= `<tr><td class="hour">${hour}:00</td>`;
  days.forEach(day=>{
    html+=`<td data-day="${day}" data-hour="${hour}"></td>`
  })
  html+="</tr>";
}
table.innerHTML = html;

// ================== KLIK: planning toevoegen ==================
document.querySelectorAll("td[data-day]").forEach(cell=>{
  cell.addEventListener("click", async ()=>{
    const text = prompt(`Wat plannen (${user}) op dit moment?`);
    if(!text) return;

    const day = cell.dataset.day;
    const hour = cell.dataset.hour;

    await setDoc(doc(db, "planning", `${day}-${hour}`), {
      text: text,
      user: user,
      color: myColor,
      updated: new Date()
    });

    cell.innerText = `${text}\n(${user})`;
    cell.style.background = myColor;
    cell.style.color = "white";
  });
});

// ================== LIVE DATA ==================
onSnap(collection(db,"planning"), (snapshot)=>{
  document.querySelectorAll("td[data-day]").forEach(c=>{
    c.innerText = "";
    c.style.background = "white";
    c.style.color = "black";
  });

  snapshot.forEach(docSnap=>{
    const [day,hour] = docSnap.id.split("-");
    const cell = document.querySelector(`td[data-day="${day}"][data-hour="${hour}"]`);

    if(cell){
      const data = docSnap.data();
      cell.innerText = `${data.text}\n(${data.user})`;
      cell.style.background = data.color;
      cell.style.color = "white";
    }
  });
});
