// ===============================
// Firebase configuratie (jij vult zelf API in)
// ===============================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCwlr069pxNXEEhIEGNug5Ly_kKSuvxSzs",
  authDomain: "homecrew-d8e21.firebaseapp.com",
  projectId: "homecrew-d8e21",
  storageBucket: "homecrew-d8e21.firebasestorage.app",
  messagingSenderId: "47664248188",
  appId: "1:47664248188:web:0994c6b2ba07f6fee060f9",
  measurementId: "G-5R58JL5D5K"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===============================
// Variabelen
// ===============================
const activeUser = localStorage.getItem("gebruikersnaam") || "Onbekend";
let map;
let myMarker;
let userMarkers = {};

// ===============================
// Google Map opstarten
// ===============================
window.initMap = function () {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 51.2, lng: 4.4 },
    zoom: 10,
    disableDefaultUI: true,
    zoomControl: true
  });

  startLocationTracking();
  subscribeToOthers();
};

// ===============================
// Live locatie volgen (batterij vriendelijk)
// ===============================
function startLocationTracking() {

  if (!navigator.geolocation) {
    alert("Geolocatie wordt niet ondersteund op dit toestel.");
    return;
  }

  navigator.geolocation.watchPosition(
    async (position) => {

      const { latitude, longitude } = position.coords;

      // Marker op eigen locatie
      const pos = { lat: latitude, lng: longitude };

      if (!myMarker) {
        myMarker = new google.maps.Marker({
          position: pos,
          map: map,
          title: "Ik (" + activeUser + ")",
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: "#0066ff",
            fillOpacity: 1,
            strokeColor: "#ffffff",
            strokeWeight: 2
          }
        });

        map.setCenter(pos);
      } else {
        myMarker.setPosition(pos);
      }

      // Opslaan in Firestore
      await setDoc(doc(db, "users_locations", activeUser), {
        latitude,
        longitude,
        username: activeUser,
        status: "online",
        timestamp: serverTimestamp()
      }, { merge: true });

      updateStatus("ðŸŸ¢ Online");

    },
    (error) => {
      updateStatus("ðŸ”´ Geen toestemming");
      alert("Je moet je locatie toestaan om deze pagina te gebruiken.");
      window.location.href = "index.html";
    },
    {
      enableHighAccuracy: true,
      maximumAge: 10000,
      timeout: 10000
    }
  );
}

// ===============================
// Andere gebruikers in real-time
// ===============================
function subscribeToOthers() {

  const locationsRef = collection(db, "users_locations");

  onSnapshot(locationsRef, (snapshot) => {

    const now = Date.now();

    snapshot.forEach((docSnap) => {
      const data = docSnap.data();

      if (!data || !data.latitude || !data.longitude) return;
      if (docSnap.id === activeUser) return;

      const lastUpdate = data.timestamp?.seconds * 1000 || 0;
      const secondsAgo = (now - lastUpdate) / 1000;

      let opacity = 1;
      let status = "ðŸŸ¢ Online";

      if (secondsAgo > 120) {
        opacity = 0.3;
        status = "âš« Offline";
      }

      const position = {
        lat: data.latitude,
        lng: data.longitude
      };

      if (userMarkers[docSnap.id]) {

        userMarkers[docSnap.id].setPosition(position);
        userMarkers[docSnap.id].setIcon({
          path: google.maps.SymbolPath.CIRCLE,
          scale: 7,
          fillColor: "#ff0000",
          fillOpacity: opacity,
          strokeColor: "#ffffff",
          strokeWeight: 1
        });

      } else {

        const marker = new google.maps.Marker({
          position: position,
          map: map,
          title: `${data.username || docSnap.id} - ${status}`,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 7,
            fillColor: "#ff0000",
            fillOpacity: opacity,
            strokeColor: "#ffffff",
            strokeWeight: 1
          }
        });

        userMarkers[docSnap.id] = marker;

      }

    });

  });
}

// ===============================
// Status tekst tonen
// ===============================
function updateStatus(text) {
  const statusEl = document.getElementById("status");
  if (statusEl) {
    statusEl.textContent = text;
  }
}
