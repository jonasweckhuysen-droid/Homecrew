<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Homecrew - Live Locatie</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="style.css">
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDo7KIQjAWmr6mNE413sky28HRM74yUaXQ"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<style>
/* ===== HEADER STIJL ===== */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:white;
}

.home-btn{
  padding:8px 12px;
  border:none;
  border-radius:10px;
  background:white;
  color:black;
  font-weight:bold;
  cursor:pointer;
}

.content{
  padding:15px;
}

.card{
  background:white;
  padding:15px;
  border-radius:20px;
}

/* ===== STATUS BAR ===== */
#statusBar {
  position: fixed;
  top: 70px;
  left: 50%;
  transform: translateX(-50%);
  background: black;
  color: white;
  padding: 6px 16px;
  border-radius: 20px;
  font-size: 14px;
  z-index: 9999;
}

/* ===== CONTROL BAR ===== */
.control-bar {
  text-align: center;
  margin-top: 10px;
}

.control-bar button {
  padding: 8px 18px;
  border-radius: 20px;
  border: none;
  cursor: pointer;
  margin: 4px;
  font-weight: bold;
}

.start-btn { background: #00c850; color: white; }
.stop-btn { background: #ff3b30; color: white; }
</style>
</head>

<body class="app-body">

<div id="statusBar">üîÑ Verbinden...</div>

<header class="topbar">
  <button onclick="window.location.href='dashboard.html'" class="home-btn">
    <i class="fas fa-home"></i>
  </button>

  <h2>üìç Live locatie</h2>

  <button onclick="logout()" class="home-btn">
    <i class="fas fa-sign-out-alt"></i>
  </button>
</header>

<main class="content">
  <h3 id="welcomeUser"></h3>

  <div class="control-bar">
    <button class="start-btn" onclick="startTracking()">‚ñ∂ Start delen</button>
    <button class="stop-btn" onclick="stopTracking()">‚èπ Stop delen</button>
  </div>

  <div class="card">
    <div id="map" style="width:100%; height:500px; border-radius:16px;"></div>
  </div>
</main>

<script type="module">
// ================= FIREBASE =================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCwlr069pxNXEEhIEGNug5Ly_kKSuvxSzs",
  authDomain: "homecrew-d8e21.firebaseapp.com",
  projectId: "homecrew-d8e21",
  storageBucket: "homecrew-d8e21.firebasestorage.app",
  messagingSenderId: "47664248188",
  appId: "1:47664248188:web:0994c6b2ba07f6fee060f9",
  measurementId: "G-5R58JL5D5K"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ================= STATUS =================
const statusBar = document.getElementById("statusBar");

// ================= GEBRUIKER =================
const activeUser = localStorage.getItem("homecrewUser") || sessionStorage.getItem("homecrewUser");

if (!activeUser) {
  window.location.href = "index.html";
}

document.getElementById("welcomeUser").textContent = "Welkom, " + activeUser + " üëã";

window.logout = function () {
  localStorage.removeItem("homecrewUser");
  sessionStorage.removeItem("homecrewUser");
  window.location.href = "index.html";
};

// ================= GOOGLE MAP =================
let map;
let markers = {};
let infoWindows = {};

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 51.2194, lng: 4.4025 },
    zoom: 10,
    mapTypeId: "roadmap"
  });
}

initMap();

// ================= KLEUREN PER GEBRUIKER =================
const userColors = {
  "jonas": "blue",
  "liese": "red",
  "loreana": "pink"
};

// ================= LIVE TRACKING =================
let watchId = null;

window.startTracking = function () {
  if (!navigator.geolocation) {
    alert("Locatie wordt niet ondersteund");
    return;
  }

  statusBar.textContent = "üü¢ Locatie delen actief";

  watchId = navigator.geolocation.watchPosition(async (position) => {
    const { latitude, longitude } = position.coords;
    map.setCenter({ lat: latitude, lng: longitude });

    await setDoc(doc(db, "users_locations", activeUser), {
      latitude,
      longitude,
      timestamp: serverTimestamp()
    }, { merge: true });

  }, (error) => {
    console.error(error);
    statusBar.textContent = "üî¥ Locatie fout: " + error.message;
  },{
    enableHighAccuracy: true,
    maximumAge: 0,
    timeout: 10000
  });
};

window.stopTracking = function () {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  statusBar.textContent = "‚õî Locatie delen gestopt";
};

// Start automatisch
startTracking();

// ================= LIVE WEERGAVE ANDEREN =================
const locationsRef = collection(db, "users_locations");

onSnapshot(locationsRef, (snapshot) => {
  snapshot.forEach((userDoc) => {

    const user = userDoc.id;
    const data = userDoc.data();

    if (!data.latitude || !data.longitude) return;

    const position = {
      lat: data.latitude,
      lng: data.longitude
    };

    const color = userColors[user.toLowerCase()] || "green";

    const lastUpdate = data.timestamp?.seconds
      ? new Date(data.timestamp.seconds * 1000).toLocaleTimeString()
      : "net bijgewerkt";

    if (markers[user]) {

      markers[user].setPosition(position);

      infoWindows[user].setContent(`
        <strong>${user}</strong><br>
        Laatste update: ${lastUpdate}
      `);

    } else {

      const marker = new google.maps.Marker({
        position,
        map,
        title: user,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 10,
          fillColor: color,
          fillOpacity: 1,
          strokeWeight: 1,
          strokeColor: "#000"
        }
      });

      const infoWindow = new google.maps.InfoWindow({
        content: `
          <strong>${user}</strong><br>
          Laatste update: ${lastUpdate}
        `
      });

      marker.addListener("click", () => {
        infoWindow.open(map, marker);
      });

      markers[user] = marker;
      infoWindows[user] = infoWindow;
    }

  });

  statusBar.textContent = "‚úÖ Live verbinding actief";
});

</script>

</body>
</html>
