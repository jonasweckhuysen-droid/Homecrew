<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Homecrew - Live Locatie</title>
<link rel="stylesheet" href="/Homecrew/style.css">

<!-- Google Maps API: vervang JOUW_GOOGLE_MAPS_API_KEY door je eigen key -->
<script src="https://maps.googleapis.com/maps/api/js?key=JOUW_GOOGLE_MAPS_API_KEY"></script>

</head>
<body>
<div class="topbar">
  <button class="back-btn" onclick="window.location.href='dashboard.html'">â¬… Terug</button>
  <span class="top-title">Live Locatie</span>
</div>

<div class="login-box">
  <h1 id="welcome"></h1>
  <div id="map" style="width:100%; height:500px; border-radius:16px; margin-top:15px;"></div>
</div>

<script type="module">
// ================= FIREBASE IMPORT =================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

// ================= FIREBASE CONFIG =================
const firebaseConfig = {
  apiKey: "AIzaSyCwlr069pxNXEEhIEGNug5Ly_kKSuvxSzs",
  authDomain: "homecrew-d8e21.firebaseapp.com",
  projectId: "homecrew-d8e21",
  storageBucket: "homecrew-d8e21.firebasestorage.app",
  messagingSenderId: "47664248188",
  appId: "1:47664248188:web:0994c6b2ba07f6fee060f9",
  measurementId: "G-5R58JL5D5K"
};

// ================= INIT FIREBASE =================
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ================= GEBRUIKER =================
const activeUser = localStorage.getItem("homecrewUser");
if (!activeUser) window.location.href = "index.html";
document.getElementById("welcome").textContent = "Welkom, " + activeUser + " ðŸ‘‹";

// ================= GOOGLE MAPS =================
let map;
let markers = {}; // houd markers per gebruiker bij
let infoWindows = {}; // info window per gebruiker

function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 51.2194, lng: 4.4025 }, // default: Antwerpen
        zoom: 10
    });
}

// ================= KLEUREN PER GEBRUIKER =================
const userColors = {
    "jonas": "blue",
    "liese": "red",
    "loreana": "pink"
    // Voeg hier extra gebruikers toe
};

// ================= LIVE LOCATIE UPDATEN =================
async function updateMyLocation() {
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const { latitude, longitude } = pos.coords;
            await setDoc(doc(db, "users", activeUser), {
                latitude,
                longitude,
                timestamp: new Date()
            }, { merge: true });
        }, (err) => console.error("Locatie fout:", err), { enableHighAccuracy: true });
    } else {
        alert("Locatie niet beschikbaar op dit toestel");
    }
}

// update elke 30 seconden
updateMyLocation();
setInterval(updateMyLocation, 30000);

// ================= LOCATIES VAN ALLE GEBRUIKERS TONEN =================
const usersCol = collection(db, "users");

onSnapshot(usersCol, (snapshot) => {
    snapshot.forEach((docSnap) => {
        const user = docSnap.id;
        const data = docSnap.data();
        if (!data.latitude || !data.longitude) return;

        const pos = { lat: data.latitude, lng: data.longitude };
        const color = userColors[user] || "green"; // standaard groen als niet ingesteld

        // Marker en info window
        if (markers[user]) {
            markers[user].setPosition(pos);
            infoWindows[user].setContent(`<strong>${user}</strong><br>Laatste update: ${new Date(data.timestamp.seconds*1000).toLocaleTimeString()}`);
        } else {
            const marker = new google.maps.Marker({
                position: pos,
                map: map,
                title: user,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: color,
                    fillOpacity: 1,
                    strokeWeight: 1,
                    strokeColor: "#000"
                }
            });
            const infoWindow = new google.maps.InfoWindow({
                content: `<strong>${user}</strong><br>Laatste update: ${new Date(data.timestamp.seconds*1000).toLocaleTimeString()}`
            });
            marker.addListener("click", () => infoWindow.open(map, marker));

            markers[user] = marker;
            infoWindows[user] = infoWindow;
        }
    });
});

// ================= START =================
initMap();
</script>
</body>
</html>
