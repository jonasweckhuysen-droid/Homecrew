<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Homecrew â€” Taken (live)</title>

<link rel="stylesheet" href="/Homecrew/style.css">

<!-- Icons -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

</head>
<body class="app-body">

<!-- âœ… AANGEPASTE HEADER -->
<header class="topbar">
  <button class="home-btn" onclick="window.location.href='/Homecrew/dashboard.html'">
    <i class="fas fa-home"></i> Dashboard
  </button>

  <h2>âœ… Taken</h2>

  <button class="home-btn" onclick="logout()">
    <i class="fas fa-sign-out-alt"></i> Uitloggen
  </button>
</header>

<div class="login-box" style="max-width:820px; margin:20px auto;">
  <h1 id="welcome">Welkom</h1>

  <div class="card" style="margin-bottom:14px;">
    <h3>Nieuwe taak toevoegen</h3>
    <input id="taskTitle" type="text" placeholder="Titel" />
    <textarea id="taskDesc" placeholder="Beschrijving (optioneel)"></textarea>
    <div style="display:flex; gap:10px;">
      <button id="addTaskBtn" class="main-btn" style="flex:1">Toevoegen</button>
      <button id="refreshBtn" class="main-btn" style="flex:0 0 130px; background:#607d8b">
        Vernieuw
      </button>
    </div>
  </div>

  <div class="card">
    <h3>Alle taken (live)</h3>
    <ul id="tasksList" class="event-list" style="padding:0; margin:0;"></ul>
  </div>
</div>

<script type="module">
/* =============================
   Homecrew â€” Live taken (Firestore)
   ============================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  query,
  orderBy,
  serverTimestamp,
  deleteDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

/* --------- Firebase config --------- */
const firebaseConfig = {
  apiKey: "AIzaSyCwlr069pxNXEEhIEGNug5Ly_kKSuvxSzs",
  authDomain: "homecrew-d8e21.firebaseapp.com",
  projectId: "homecrew-d8e21",
  storageBucket: "homecrew-d8e21.firebasestorage.app",
  messagingSenderId: "47664248188",
  appId: "1:47664248188:web:0994c6b2ba07f6fee060f9",
  measurementId: "G-5R58JL5D5K"
};

/* --------- Init Firebase --------- */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* --------- Hulp: gebruikerskleuren --------- */
function getUserColor(name) {
  const n = (name || "").toLowerCase();
  if (n === "jonas") return "#3498db";
  if (n === "liese") return "#e74c3c";
  if (n === "loreana") return "#ff69b4";
  return "#666";
}

/* --------- Huidige gebruiker --------- */
const activeUser =
  localStorage.getItem("homecrewUser") ||
  sessionStorage.getItem("homecrewUser");

if (!activeUser) {
  window.location.href = "/Homecrew/index.html";
}

document.getElementById("welcome").innerText =
  "Welkom, " + activeUser + " ðŸ‘‹";

/* --------- DOM refs --------- */
const tasksListEl = document.getElementById("tasksList");
const addBtn = document.getElementById("addTaskBtn");
const refreshBtn = document.getElementById("refreshBtn");
const titleInput = document.getElementById("taskTitle");
const descInput = document.getElementById("taskDesc");

/* --------- Add taak --------- */
async function addTask() {
  const title = titleInput.value.trim();
  const desc = descInput.value.trim();

  if (!title) {
    alert("Vul een titel in voor de taak");
    return;
  }

  try {
    await addDoc(collection(db, "tasks"), {
      title,
      desc,
      user: activeUser,
      createdAt: serverTimestamp()
    });

    titleInput.value = "";
    descInput.value = "";
    console.log("âœ… Taak toegevoegd");

  } catch (err) {
    console.error("Fout bij toevoegen taak:", err);
    alert("Kon taak niet toevoegen. Kijk console voor details.");
  }
}

/* --------- Delete taak --------- */
async function deleteTask(docId) {
  if (!confirm("Verwijder deze taak?")) return;

  try {
    await deleteDoc(doc(db, "tasks", docId));
  } catch (err) {
    console.error("Fout bij verwijderen:", err);
    alert("Kon taak niet verwijderen.");
  }
}

/* --------- Realtime listener --------- */
function startTasksListener() {
  const q = query(collection(db, "tasks"), orderBy("createdAt", "asc"));

  return onSnapshot(q, (snapshot) => {
    tasksListEl.innerHTML = "";

    snapshot.forEach((docSnap) => {
      const data = docSnap.data();
      const id = docSnap.id;

      const li = document.createElement("li");
      li.className = "event-item";
      li.style.display = "flex";
      li.style.justifyContent = "space-between";
      li.style.alignItems = "center";
      li.style.padding = "12px";
      li.style.marginBottom = "10px";

      const left = document.createElement("div");
      left.style.flex = "1";

      const titleEl = document.createElement("strong");
      titleEl.textContent = data.title || "(geen titel)";
      titleEl.style.display = "block";
      titleEl.style.fontSize = "16px";
      titleEl.style.marginBottom = "6px";

      const descEl = document.createElement("div");
      descEl.textContent = data.desc || "";
      descEl.style.fontSize = "14px";
      descEl.style.opacity = "0.9";

      const metaEl = document.createElement("div");
      metaEl.style.marginTop = "6px";
      metaEl.style.fontSize = "12px";

      const userColor = getUserColor(data.user);

      metaEl.innerHTML = `
        ðŸ‘¤ <span style="color:${userColor}; font-weight:600">${data.user || "?"}</span>
        â€¢ ${data.createdAt && data.createdAt.toDate
          ? new Date(data.createdAt.toDate()).toLocaleString("nl-BE")
          : ""}
      `;

      left.appendChild(titleEl);
      left.appendChild(descEl);
      left.appendChild(metaEl);

      const right = document.createElement("div");
      right.style.marginLeft = "12px";
      right.style.display = "flex";
      right.style.alignItems = "center";

      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.style.background = "#DA4453";
      delBtn.style.color = "white";
      delBtn.style.border = "none";
      delBtn.style.borderRadius = "8px";
      delBtn.style.padding = "6px 10px";
      delBtn.style.cursor = "pointer";
      delBtn.textContent = "âŒ";
      delBtn.onclick = () => deleteTask(id);

      right.appendChild(delBtn);

      li.appendChild(left);
      li.appendChild(right);

      tasksListEl.appendChild(li);
    });

    if (!tasksListEl.hasChildNodes()) {
      const empty = document.createElement("div");
      empty.style.padding = "14px";
      empty.style.opacity = "0.9";
      empty.textContent = "Nog geen taken â€” voeg er een toe!";
      tasksListEl.appendChild(empty);
    }

  }, (err) => {
    console.error("Listener error:", err);
  });
}

/* --------- Events --------- */
addBtn.addEventListener("click", addTask);

refreshBtn.addEventListener("click", () => {
  if (unsubscribe) unsubscribe();
  unsubscribe = startTasksListener();
});

/* --------- Logout --------- */
function logout() {
  localStorage.removeItem("homecrewUser");
  sessionStorage.removeItem("homecrewUser");
  window.location.href = "/Homecrew/index.html";
}

/* --------- Start --------- */
let unsubscribe = startTasksListener();

</script>

</body>
</html>
